<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒª - GASç‰ˆ</title>
    <?!= include('styles'); ?>
</head>
<body>
    <div class="container">
        <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
        <div id="loginScreen" class="login-screen">
            <h1>ğŸ  å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒª</h1>
            <p class="subtitle">Google Apps Scriptç‰ˆ</p>
            <div class="login-form">
                <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" maxlength="4">
                <button onclick="login()" class="btn-primary">ãƒ­ã‚°ã‚¤ãƒ³</button>
            </div>
            <div class="password-hints">
                <p>ğŸ’¡ èª­ã¿å–ã‚Šå°‚ç”¨: <code>0317</code></p>
                <p>ğŸ’¡ ç·¨é›†å¯èƒ½: <code>r246</code></p>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªç”»é¢ -->
        <div id="appContent" class="app-content" style="display: none;">
            <div class="header">
                <h1>ğŸ  å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒª <span class="version">GASç‰ˆ</span></h1>
                <div class="user-info">
                    <span id="userMode"></span>
                    <button onclick="logout()" class="btn-secondary">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
            </div>

            <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
            <div id="statisticsPanel" class="statistics-panel">
                <div class="stat-item">
                    <div class="stat-label">ç·æ”¯å‡º</div>
                    <div class="stat-value" id="totalAmount">Â¥0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ä»¶æ•°</div>
                    <div class="stat-value" id="totalCount">0ä»¶</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">å¹³å‡</div>
                    <div class="stat-value" id="averageAmount">Â¥0</div>
                </div>
            </div>

            <!-- æ”¯å‡ºè¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰ -->
            <div id="addExpenseForm" class="form-section" style="display: none;">
                <h2>ğŸ’° æ”¯å‡ºã‚’è¿½åŠ </h2>
                <form id="expenseForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date">æ—¥ä»˜</label>
                            <input type="date" id="date" required>
                        </div>
                        <div class="form-group">
                            <label for="category">ã‚«ãƒ†ã‚´ãƒª</label>
                            <select id="category" required>
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="é£Ÿè²»">é£Ÿè²»</option>
                                <option value="äº¤é€šè²»">äº¤é€šè²»</option>
                                <option value="å¨¯æ¥½">å¨¯æ¥½</option>
                                <option value="æ—¥ç”¨å“">æ—¥ç”¨å“</option>
                                <option value="åŒ»ç™‚è²»">åŒ»ç™‚è²»</option>
                                <option value="ãã®ä»–">ãã®ä»–</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="product">å•†å“å</label>
                            <input type="text" id="product" placeholder="ä¾‹: ãƒ‘ãƒ³" required>
                        </div>
                        <div class="form-group">
                            <label for="store">åº—èˆ—</label>
                            <input type="text" id="store" placeholder="ä¾‹: ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="amount">é‡‘é¡</label>
                            <input type="number" id="amount" placeholder="150" required min="0" step="1">
                        </div>
                        <div class="form-group form-actions">
                            <button type="submit" class="btn-primary">è¿½åŠ </button>
                            <button type="button" onclick="clearForm()" class="btn-secondary">ã‚¯ãƒªã‚¢</button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- æ”¯å‡ºä¸€è¦§ -->
            <div class="list-section">
                <h2>ğŸ“‹ æ”¯å‡ºä¸€è¦§</h2>
                <div class="loading" id="loadingIndicator">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="expensesList" class="expenses-list"></div>
                <div id="noDataMessage" class="no-data" style="display: none;">
                    ã¾ã æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentUser = null;
        let expenses = [];

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            document.getElementById('date').valueAsDate = today;

            // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('expenseForm').addEventListener('submit', addExpense);

            // Enterã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
        });

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        function login() {
            const password = document.getElementById('passwordInput').value;

            if (password === '0317') {
                currentUser = { mode: 'readonly', name: 'é–²è¦§ãƒ¦ãƒ¼ã‚¶ãƒ¼' };
                showApp();
            } else if (password === 'r246') {
                currentUser = { mode: 'edit', name: 'ç·¨é›†ãƒ¦ãƒ¼ã‚¶ãƒ¼' };
                showApp();
            } else {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                document.getElementById('passwordInput').value = '';
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        function logout() {
            currentUser = null;
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('appContent').style.display = 'none';
            document.getElementById('passwordInput').value = '';
        }

        // ã‚¢ãƒ—ãƒªç”»é¢ã‚’è¡¨ç¤º
        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContent').style.display = 'block';

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
            const userInfo = currentUser.mode === 'edit' ? 'ç·¨é›†ãƒ¢ãƒ¼ãƒ‰' : 'èª­ã¿å–ã‚Šå°‚ç”¨';
            document.getElementById('userMode').textContent = userInfo;

            // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®è¡¨ç¤º/éè¡¨ç¤º
            const addForm = document.getElementById('addExpenseForm');
            addForm.style.display = currentUser.mode === 'edit' ? 'block' : 'none';

            // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            loadExpenses();
        }

        // æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        function loadExpenses() {
            showLoading(true);

            google.script.run
                .withSuccessHandler(function(result) {
                    showLoading(false);
                    if (result.success) {
                        expenses = result.data;
                        displayExpenses();
                        updateStatistics();
                    } else {
                        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    showLoading(false);
                    alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.toString());
                })
                .getExpenses();
        }

        // æ”¯å‡ºã‚’è¿½åŠ 
        function addExpense(event) {
            event.preventDefault();

            if (currentUser.mode !== 'edit') {
                alert('ç·¨é›†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const formData = {
                date: document.getElementById('date').value,
                category: document.getElementById('category').value,
                product: document.getElementById('product').value,
                store: document.getElementById('store').value,
                amount: document.getElementById('amount').value
            };

            if (!formData.date || !formData.category || !formData.product || !formData.store || !formData.amount) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            showLoading(true);

            google.script.run
                .withSuccessHandler(function(result) {
                    showLoading(false);
                    if (result.success) {
                        clearForm();
                        loadExpenses(); // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                    } else {
                        alert('æ”¯å‡ºã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    showLoading(false);
                    alert('æ”¯å‡ºã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.toString());
                })
                .addExpense(formData);
        }

        // æ”¯å‡ºã‚’å‰Šé™¤
        function deleteExpense(id) {
            if (currentUser.mode !== 'edit') {
                alert('ç·¨é›†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            if (!confirm('ã“ã®æ”¯å‡ºã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            showLoading(true);

            google.script.run
                .withSuccessHandler(function(result) {
                    showLoading(false);
                    if (result.success) {
                        loadExpenses(); // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                    } else {
                        alert('æ”¯å‡ºã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    showLoading(false);
                    alert('æ”¯å‡ºã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.toString());
                })
                .deleteExpense(id);
        }

        // æ”¯å‡ºä¸€è¦§ã‚’è¡¨ç¤º
        function displayExpenses() {
            const container = document.getElementById('expensesList');
            const noDataMessage = document.getElementById('noDataMessage');

            if (expenses.length === 0) {
                container.style.display = 'none';
                noDataMessage.style.display = 'block';
                return;
            }

            container.style.display = 'block';
            noDataMessage.style.display = 'none';

            const html = expenses.map(expense => {
                const deleteButton = currentUser.mode === 'edit'
                    ? `<button onclick="deleteExpense(${expense.id})" class="btn-delete">å‰Šé™¤</button>`
                    : '';

                return `
                    <div class="expense-item">
                        <div class="expense-main">
                            <div class="expense-date">${expense.date}</div>
                            <div class="expense-details">
                                <div class="expense-product">${expense.product}</div>
                                <div class="expense-meta">
                                    <span class="expense-category">${expense.category}</span> |
                                    <span class="expense-store">${expense.store}</span>
                                </div>
                            </div>
                            <div class="expense-amount">Â¥${expense.amount.toLocaleString()}</div>
                        </div>
                        <div class="expense-actions">
                            ${deleteButton}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
        function updateStatistics() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        const stats = result.data;
                        document.getElementById('totalAmount').textContent = 'Â¥' + stats.total.toLocaleString();
                        document.getElementById('totalCount').textContent = stats.count + 'ä»¶';
                        document.getElementById('averageAmount').textContent = 'Â¥' + stats.average.toLocaleString();
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('çµ±è¨ˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—:', error);
                })
                .getStatistics();
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
        function clearForm() {
            document.getElementById('category').value = '';
            document.getElementById('product').value = '';
            document.getElementById('store').value = '';
            document.getElementById('amount').value = '';

            // æ—¥ä»˜ã¯ä»Šæ—¥ã®æ—¥ä»˜ã«æˆ»ã™
            const today = new Date();
            document.getElementById('date').valueAsDate = today;
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        function showLoading(show) {
            const indicator = document.getElementById('loadingIndicator');
            indicator.style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html>