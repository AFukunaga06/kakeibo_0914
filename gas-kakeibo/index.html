<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家計簿アプリ - GAS版</title>
    <?!= include('styles'); ?>
</head>
<body>
    <div class="container">
        <!-- ログイン画面 -->
        <div id="loginScreen" class="login-screen">
            <h1>🏠 家計簿アプリ</h1>
            <p class="subtitle">Google Apps Script版</p>
            <div class="login-form">
                <input type="password" id="passwordInput" placeholder="パスワードを入力" maxlength="4">
                <button onclick="login()" class="btn-primary">ログイン</button>
            </div>
            <div class="password-hints">
                <p>💡 読み取り専用: <code>0317</code></p>
                <p>💡 編集可能: <code>r246</code></p>
            </div>
        </div>

        <!-- メインアプリ画面 -->
        <div id="appContent" class="app-content" style="display: none;">
            <div class="header">
                <h1>🏠 家計簿アプリ <span class="version">GAS版</span></h1>
                <div class="user-info">
                    <span id="userMode"></span>
                    <button onclick="logout()" class="btn-secondary">ログアウト</button>
                </div>
            </div>

            <!-- 統計サマリー -->
            <div id="statisticsPanel" class="statistics-panel">
                <div class="stat-item">
                    <div class="stat-label">総支出</div>
                    <div class="stat-value" id="totalAmount">¥0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">件数</div>
                    <div class="stat-value" id="totalCount">0件</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">平均</div>
                    <div class="stat-value" id="averageAmount">¥0</div>
                </div>
            </div>

            <!-- 支出追加フォーム（編集モードのみ） -->
            <div id="addExpenseForm" class="form-section" style="display: none;">
                <h2>💰 支出を追加</h2>
                <form id="expenseForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date">日付</label>
                            <input type="date" id="date" required>
                        </div>
                        <div class="form-group">
                            <label for="category">カテゴリ</label>
                            <select id="category" required>
                                <option value="">選択してください</option>
                                <option value="食費">食費</option>
                                <option value="交通費">交通費</option>
                                <option value="娯楽">娯楽</option>
                                <option value="日用品">日用品</option>
                                <option value="医療費">医療費</option>
                                <option value="その他">その他</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="product">商品名</label>
                            <input type="text" id="product" placeholder="例: パン" required>
                        </div>
                        <div class="form-group">
                            <label for="store">店舗</label>
                            <input type="text" id="store" placeholder="例: セブンイレブン" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="amount">金額</label>
                            <input type="number" id="amount" placeholder="150" required min="0" step="1">
                        </div>
                        <div class="form-group form-actions">
                            <button type="submit" class="btn-primary">追加</button>
                            <button type="button" onclick="clearForm()" class="btn-secondary">クリア</button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- 支出一覧 -->
            <div class="list-section">
                <h2>📋 支出一覧</h2>
                <div class="loading" id="loadingIndicator">データを読み込み中...</div>
                <div id="expensesList" class="expenses-list"></div>
                <div id="noDataMessage" class="no-data" style="display: none;">
                    まだ支出データがありません
                </div>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let currentUser = null;
        let expenses = [];

        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            document.getElementById('date').valueAsDate = today;

            // フォーム送信イベント
            document.getElementById('expenseForm').addEventListener('submit', addExpense);

            // Enterキーでログイン
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
        });

        // ログイン処理
        function login() {
            const password = document.getElementById('passwordInput').value;

            if (password === '0317') {
                currentUser = { mode: 'readonly', name: '閲覧ユーザー' };
                showApp();
            } else if (password === 'r246') {
                currentUser = { mode: 'edit', name: '編集ユーザー' };
                showApp();
            } else {
                alert('パスワードが正しくありません');
                document.getElementById('passwordInput').value = '';
            }
        }

        // ログアウト処理
        function logout() {
            currentUser = null;
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('appContent').style.display = 'none';
            document.getElementById('passwordInput').value = '';
        }

        // アプリ画面を表示
        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContent').style.display = 'block';

            // ユーザー情報を表示
            const userInfo = currentUser.mode === 'edit' ? '編集モード' : '読み取り専用';
            document.getElementById('userMode').textContent = userInfo;

            // 編集フォームの表示/非表示
            const addForm = document.getElementById('addExpenseForm');
            addForm.style.display = currentUser.mode === 'edit' ? 'block' : 'none';

            // データを読み込み
            loadExpenses();
        }

        // 支出データを読み込み
        function loadExpenses() {
            showLoading(true);

            google.script.run
                .withSuccessHandler(function(result) {
                    showLoading(false);
                    if (result.success) {
                        expenses = result.data;
                        displayExpenses();
                        updateStatistics();
                    } else {
                        alert('データの読み込みに失敗しました: ' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    showLoading(false);
                    alert('データの読み込みに失敗しました: ' + error.toString());
                })
                .getExpenses();
        }

        // 支出を追加
        function addExpense(event) {
            event.preventDefault();

            if (currentUser.mode !== 'edit') {
                alert('編集権限がありません');
                return;
            }

            const formData = {
                date: document.getElementById('date').value,
                category: document.getElementById('category').value,
                product: document.getElementById('product').value,
                store: document.getElementById('store').value,
                amount: document.getElementById('amount').value
            };

            if (!formData.date || !formData.category || !formData.product || !formData.store || !formData.amount) {
                alert('すべての項目を入力してください');
                return;
            }

            showLoading(true);

            google.script.run
                .withSuccessHandler(function(result) {
                    showLoading(false);
                    if (result.success) {
                        clearForm();
                        loadExpenses(); // データを再読み込み
                    } else {
                        alert('支出の追加に失敗しました: ' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    showLoading(false);
                    alert('支出の追加に失敗しました: ' + error.toString());
                })
                .addExpense(formData);
        }

        // 支出を削除
        function deleteExpense(id) {
            if (currentUser.mode !== 'edit') {
                alert('編集権限がありません');
                return;
            }

            if (!confirm('この支出を削除しますか？')) {
                return;
            }

            showLoading(true);

            google.script.run
                .withSuccessHandler(function(result) {
                    showLoading(false);
                    if (result.success) {
                        loadExpenses(); // データを再読み込み
                    } else {
                        alert('支出の削除に失敗しました: ' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    showLoading(false);
                    alert('支出の削除に失敗しました: ' + error.toString());
                })
                .deleteExpense(id);
        }

        // 支出一覧を表示
        function displayExpenses() {
            const container = document.getElementById('expensesList');
            const noDataMessage = document.getElementById('noDataMessage');

            if (expenses.length === 0) {
                container.style.display = 'none';
                noDataMessage.style.display = 'block';
                return;
            }

            container.style.display = 'block';
            noDataMessage.style.display = 'none';

            const html = expenses.map(expense => {
                const deleteButton = currentUser.mode === 'edit'
                    ? `<button onclick="deleteExpense(${expense.id})" class="btn-delete">削除</button>`
                    : '';

                return `
                    <div class="expense-item">
                        <div class="expense-main">
                            <div class="expense-date">${expense.date}</div>
                            <div class="expense-details">
                                <div class="expense-product">${expense.product}</div>
                                <div class="expense-meta">
                                    <span class="expense-category">${expense.category}</span> |
                                    <span class="expense-store">${expense.store}</span>
                                </div>
                            </div>
                            <div class="expense-amount">¥${expense.amount.toLocaleString()}</div>
                        </div>
                        <div class="expense-actions">
                            ${deleteButton}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // 統計情報を更新
        function updateStatistics() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        const stats = result.data;
                        document.getElementById('totalAmount').textContent = '¥' + stats.total.toLocaleString();
                        document.getElementById('totalCount').textContent = stats.count + '件';
                        document.getElementById('averageAmount').textContent = '¥' + stats.average.toLocaleString();
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('統計情報の取得に失敗:', error);
                })
                .getStatistics();
        }

        // フォームをクリア
        function clearForm() {
            document.getElementById('category').value = '';
            document.getElementById('product').value = '';
            document.getElementById('store').value = '';
            document.getElementById('amount').value = '';

            // 日付は今日の日付に戻す
            const today = new Date();
            document.getElementById('date').valueAsDate = today;
        }

        // ローディング表示
        function showLoading(show) {
            const indicator = document.getElementById('loadingIndicator');
            indicator.style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html>